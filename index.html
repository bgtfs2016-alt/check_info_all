<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tra cứu POSID & Serial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f9fafc; display: flex; flex-direction: column; min-height: 100vh; }
    header { background: #0d6efd; color: white; padding: 1rem; }
    footer { background: #0d6efd; color: white; text-align: center; padding: 0.5rem; margin-top: auto; }
    .nav-tabs .nav-link.active { background-color: #e7f1ff; border-color: #0d6efd #0d6efd #fff; }
    .tab-content { padding: 1rem; background: white; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 .5rem .5rem; }
    table { font-size: 0.9rem; }
  </style>
</head>
<body>
<header>
  <h3><i class="bi bi-database"></i> Hệ thống tra cứu dữ liệu</h3>
</header>

<div class="container my-4">
  <!-- Tabs -->
  <ul class="nav nav-tabs" id="dataTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="posid-tab" data-bs-toggle="tab" data-bs-target="#posid" type="button" role="tab">
        <i class="bi bi-search"></i> Tra cứu POSID
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="serial-tab" data-bs-toggle="tab" data-bs-target="#serial" type="button" role="tab">
        <i class="bi bi-hdd-network"></i> Tra cứu Serial
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="vitri-tab" data-bs-toggle="tab" data-bs-target="#vitri" type="button" role="tab">
        <i class="bi bi-geo-alt"></i> Vị trí thiết bị
      </button>
    </li>
  </ul>

  <!-- Tab contents -->
  <div class="tab-content">
    <!-- MasterAsset -->
    <div class="tab-pane fade show active" id="posid" role="tabpanel">
      <div class="input-group mb-3">
        <input type="text" id="posidInput" class="form-control" placeholder="Nhập POSID hoặc POSID cũ">
        <button class="btn btn-primary" onclick="searchPOSID()">Tìm</button>
      </div>
      <div id="posidResult"></div>
    </div>
    <!-- Exp -->
    <div class="tab-pane fade" id="serial" role="tabpanel">
      <div class="input-group mb-3">
        <input type="text" id="serialInput" class="form-control" placeholder="Nhập Serial thiết bị">
        <button class="btn btn-primary" onclick="searchSerial()">Tìm</button>
      </div>
      <div id="serialResult"></div>
    </div>
    <!-- Vị trí -->
    <div class="tab-pane fade" id="vitri" role="tabpanel">
      <div class="input-group mb-3">
        <input type="text" id="vitriInput" class="form-control" placeholder="Nhập POSID">
        <button class="btn btn-primary" onclick="searchVitri()">Tìm</button>
      </div>
      <div id="vitriResult"></div>
    </div>
  </div>
</div>

<footer>
  <small>&copy; 2025 Tra cứu dữ liệu POSID & Serial</small>
</footer>

<script>
// 1) Link JSON (thay bằng link GitHub Pages/Cloudflare Pages của bạn)
const JSON_URLS = {
  master: "https://bgtfs2016-alt.github.io/check_info_all/MasterAsset.json",
  exp: "https://bgtfs2016-alt.github.io/check_info_all/Exp.json",
  vitri: "https://bgtfs2016-alt.github.io/check_info_all/Vi_tri_month.json"
};

let cache = { master: null, exp: null, vitri: null };
let loading = { master: false, exp: false, vitri: false };

// 2) Spinner khi load
async function loadJsonOnce(key, holderId) {
  if (cache[key] || loading[key]) return cache[key];
  loading[key] = true;
  const holder = document.getElementById(holderId);
  const old = holder.innerHTML;
  holder.innerHTML = `<div class="text-center my-3">
    <div class="spinner-border" role="status"></div>
    <div class="mt-2 small text-muted">Đang tải dữ liệu...</div>
  </div>`;
  try {
    const res = await fetch(JSON_URLS[key], { cache: "force-cache" });
    cache[key] = await res.json();
    return cache[key];
  } catch (e) {
    holder.innerHTML = `<p class="text-danger">Lỗi tải dữ liệu: ${e}</p>`;
    throw e;
  } finally {
    loading[key] = false;
    if (!cache[key]) holder.innerHTML = old;
  }
}

// 3) Hàm xuất Excel
function exportExcel(rows, sheetName, fileName) {
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, fileName);
}

// 4) Tìm kiếm
async function searchPOSID() {
  const posid = document.getElementById("posidInput").value.trim();
  const data = await loadJsonOnce('master','posidResult');
  const found = data.filter(r =>
    String(r["POSID"]||"").trim() === posid ||
    String(r["POSID Cũ"]||"").trim() === posid
  );
  renderTable(found, "posidResult", "Kết quả MasterAsset", "MasterAsset.xlsx");
}

async function searchSerial() {
  const serial = document.getElementById("serialInput").value.trim();
  const data = await loadJsonOnce('exp','serialResult');
  const found = data.filter(r => String(r["Serial"]||"").trim() === serial);
  renderTable(found, "serialResult", "Kết quả Exp", "Exp.xlsx");
}

async function searchVitri() {
  const posid = document.getElementById("vitriInput").value.trim();
  const data = await loadJsonOnce('vitri','vitriResult');
  const found = data.filter(r => String(r["POSID"]||"").trim() === posid);
  renderTable(found, "vitriResult", "Kết quả Vị trí", "Vitri.xlsx");
}

// 5) Render bảng kết quả
function renderTable(rows, holderId, title, fileName) {
  const box = document.getElementById(holderId);
  if (!rows.length) {
    box.innerHTML = `<p class='text-danger'>Không tìm thấy dữ liệu</p>`;
    return;
  }
  let headers = Object.keys(rows[0]);
  let html = `<h5>${title}</h5>
    <div class="table-responsive"><table class="table table-bordered table-sm">
    <thead class="table-light"><tr>`;
  headers.forEach(h => html += `<th>${h}</th>`);
  html += `</tr></thead><tbody>`;
  rows.forEach(r => {
    html += "<tr>";
    headers.forEach(h => html += `<td>${r[h]||""}</td>`);
    html += "</tr>";
  });
  html += `</tbody></table></div>
    <button class="btn btn-success btn-sm" onclick='exportExcel(${JSON.stringify(rows)}, "${title}", "${fileName}")'>
      <i class="bi bi-file-earmark-excel"></i> Xuất Excel
    </button>`;
  box.innerHTML = html;
}

// 6) Lazy load khi mở tab
document.getElementById('posid-tab')?.addEventListener('shown.bs.tab', () => loadJsonOnce('master','posidResult'));
document.getElementById('serial-tab')?.addEventListener('shown.bs.tab', () => loadJsonOnce('exp','serialResult'));
document.getElementById('vitri-tab')?.addEventListener('shown.bs.tab', () => loadJsonOnce('vitri','vitriResult'));

// Tải sớm tab mặc định
loadJsonOnce('master','posidResult');
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
